/* SITE ARCHITECTURE */

Opens directly from filesystem - no web server required.

/* DIRECTORY STRUCTURE */

Each page is an index.html in its own directory. The root _script/view.js
is shared across all pages. Directories may contain _asset/ for source files.

/* HTML PAGE FORMAT */

Pages contain:
  1. A <script> tag loading the relative path to _script/view.js
  2. A <noscript> tag with link to sitemap.html (for no-JS browsers)
  3. The body content (starting with an <h1>)

The script injects viewport meta, inline styles, header (breadcrumbs + section
nav), wraps content in <main>, and adds a footer with Top link.

/* LAYOUT */

Single column, full width, browser defaults. Sticky header with backdrop blur.

Breadcrumbs and section nav both left-aligned with gap between.

/* NAVIGATION */

Pages with children are "sections". Pages without children are "leaves".

Site title: Bold link to home, text from sitemap root entry.

Breadcrumbs: Path to current section with / separator. All items linked
except current section (plain text). Leaf pages don't add breadcrumb depth.

Section nav: Children of current section. On leaf pages, shows siblings
with current page as plain text.

Unlisted pages: Pages not in the sitemap inherit navigation from their
nearest ancestor that is in the sitemap. For example, individual blog posts
show the same navigation as the blog section page.

Footer: Right-aligned Top link, only visible when page is scrollable and
not at top.

/* SITEMAP */

Navigation structure is defined in sitemap/index.html. Run `make sitemap`
to generate _script/sitemap.js which is loaded by view.js. The sitemap
page appears in navigation like any other page.

/* AUTHORING */

To create a new page:
  1. Create a directory with index.html
  2. Add script tag, noscript tag, and content starting with <h1>
  3. Add the page to sitemap.html
  4. Run `make sitemap`

/* EDITING */

Ctrl+E or ?edit enters edit mode. Content becomes editable in the browser.
A sticky toolbar appears at the top with shortcuts help, save options, and
View link. The header/footer are hidden.

Keyboard shortcuts:
  Ctrl+2/3/4  Heading levels
  Ctrl+0      Paragraph
  Ctrl+L      Bulleted list
  Tab         Indent list item
  Shift+Tab   Dedent list item
  Ctrl+K      Add/edit link (select text first, prompt for URL, empty to remove)
  Ctrl+B      Bold/strong (select text first)
  Ctrl+I      Italic/em (text selected) or alt text (image/video selected)

Ctrl+J      Cycle fit mode (image/video selected, see Fit modes below)
Ctrl+.      Rotate image 90° clockwise (cycles: 0 -> 90 -> 180 -> 270 -> 0)
Ctrl+[ / ]  Fine rotate image -1° / +1° (works with any rotation)
Ctrl+, / /  Zoom out / in 2% (100% minimum, 200% maximum)
Ctrl+Arrow  Pan image 1% in direction (range limited by zoom level)
Ctrl+Enter  Save (server mode only)

Transforms in edit mode: Images with rotation, zoom, or pan show a purple
outline and a label at bottom-left (e.g., "93° 110% x5 y3"). Use View mode
to see actual transforms applied.

Selection in JS: Text selection returns content via selection.toString().
Media selection brackets the element within its parent - the range's
startContainer equals endContainer, and endOffset - startOffset equals 1,
with the media at childNodes[startOffset].

Videos in edit mode have no controls (static preview like images). Click to
select, then use Ctrl+I for alt text or Ctrl+J for fit mode. Use View mode
to preview playback.

Drag and drop images or videos onto page to insert. Media shows as previews
and is referenced by SHA256 hash (first 12 chars):
  - Images: _gallery/HASH.jpg
  - Videos: _gallery/HASH.mp4 with poster="_gallery/HASH-poster.jpg"

Dimensions stored as data-width and data-height. Videos also store
data-duration (in seconds). Images can have:
  - data-rotate: any degree 0-359 (90° increments via Ctrl+., fine via Ctrl+[/])
  - data-zoom: percentage 100-200 (default 100, omitted when 100)
  - data-pan-x: horizontal offset -50 to +50 (default 0, omitted when 0)
  - data-pan-y: vertical offset -50 to +50 (default 0, omitted when 0)

Transforms in view mode: Images with rotation, zoom, or pan are wrapped in a
.rotate-wrapper div. The wrapper uses aspect-ratio to maintain shape. For
rotations near 90°/270°, dimensions are swapped.

Auto-scale: Two types of automatic scaling are applied:
  1. Cover scale: When image aspect differs from wrapper (e.g., landscape image
     in portrait wrapper), scale up so image fills the wrapper completely.
  2. Rotation scale: Non-90° rotations leave corner gaps; getRotationScale()
     calculates the minimum scale to fill the frame.
User zoom (data-zoom) is applied on top of both auto-scales.

Pan limits: Pan is clamped based on zoom level to prevent showing edges. At
zoom=100%, no pan is allowed (image exactly fills frame). Higher zoom allows
more pan range, calculated as: maxPan = ((scale - 1) / scale) * 50.

Transform application: The image is positioned with translate (centered + pan),
then rotated, then scaled. The wrapper clips via overflow: hidden.

Fit modes (Ctrl+J cycles: none -> toowide -> tootall -> square):
  - toowide: Crop to match the aspect ratio of a reference image in the row.
    Use when an image is wider than others and needs to match their height.
  - tootall: Same as toowide (both find a reference and crop to match).
  - square: Force 1:1 visual aspect ratio. Useful for uniform thumbnails.
  - none: Remove fit mode, use natural aspect ratio.

Fit modes work with rotated images. A 90° rotated portrait becomes landscape;
marking it "toowide" next to a portrait will crop it to match. The cover scale
ensures the rotated image fills the target aspect ratio completely.

Edit mode outlines: Purple for rotation/zoom/pan, green for square fit,
orange for toowide/tootall.

The srcset sizes hint is also scaled up for rotated+fit images, so the browser
fetches a larger source image. For example, a 1.5x scale on a 500px display
width requests 750px, prompting the browser to pick the 800px variant.

Note: Drag-and-drop uses crypto.subtle for hashing, which requires a secure
context (localhost or HTTPS). Access via IP address over HTTP won't work.

Gallery rows: Images and videos on the same line form a gallery row. Press
Enter between media to create separate rows. In the DOM, each row is wrapped
in a <p> element for consistent browser behavior. The saved HTML outputs
media tags directly (one row per line) which view.js wraps into gallery
tables. Mixed rows of images and videos are supported.

Scroll preservation: Edit mode saves and restores scroll position when the
DOM is cleaned (on paste, save, copy, download hover). This prevents the
page from jumping to the top during editing.

Saving:
  "Copy HTML" - copies formatted HTML to clipboard via navigator.clipboard API
  "Save" - (server mode only) POSTs the HTML to the server, which writes it
           directly to the file. Only appears when served via HTTP.
  "Download" - creates a Blob with text/html content, generates a temporary URL
               via URL.createObjectURL(), triggers download via anchor click.
               Right-click and "Save As" to choose location.
  "View" - exits edit mode (navigates to page without ?edit)

ContentEditable approach: The editor uses native contentEditable for cursor
movement, selection, copy/paste, undo/redo, and accessibility. The tradeoff
is inconsistent DOM across browsers and dirty paste from external sources.

DOM cleaning (cleanDOM function, runs on paste and before save):
  - Normalize tags: <b> → <strong>, <i> → <em>
  - Unwrap unknown elements (keep children, remove wrapper)
  - Unwrap block elements inside <li> (list content is inline)
  - For allowed elements: remove all attributes, restore only permitted ones
  - Merge adjacent text nodes, remove empty formatting elements
  - Remove all <br> elements (gallery rows are now <p> elements, not BR-separated)
  - Convert absolute _gallery/ URLs to relative paths (handles cross-page paste,
    including poster files and size variants like HASH-800.jpg, HASH-poster.jpg)

Allowed elements and attributes (ALLOWED object in edit.js):
  h1-h6, p, ul, li    No attributes
  a                   href only
  strong, em          No attributes
  img                 src, alt, data-{fit,rotate,zoom,panX,panY,width,height,hash}, class=pending
  video               src, alt, poster, data-{fit,width,height,duration,hash}, class=pending

/* DEVELOPMENT SERVER */

Run `make serve` to start the development server. This uses serve.py, a simple
Python HTTP server that serves static files and handles POST requests to save
edited pages directly to disk.

The server:
  - Binds to 0.0.0.0:8000 (accessible from other devices on the network)
  - Serves static files like Python's built-in http.server
  - Accepts POST to any /path/index.html and writes the body to that file
  - Redirects back to the page after saving

serve.py is intentionally minimal and readable - see the source for details.

/* MEDIA GALLERIES */

Consecutive <img> and <video> tags form a row. The script wraps them in a
table with equal-width columns. Separate rows with any block element (p, h2,
etc) or line breaks in the source HTML. Images and videos can be mixed in
the same row.

Scroll snapping: Gallery rows have scroll-snap-align: start with proximity
snapping. This helps align photos with scroll positions despite browser
scroll quantization (especially in Firefox). The scroll-margin-top accounts
for the sticky header.

Square images: Images with data-fit="square" have their wrapper constrained
to max-height: 90vh and max-width: 90vh. On wide viewports, square images
display at viewport height rather than filling the full table column width,
ensuring they remain fully visible.

/* MEDIA PROCESSING */

Images and videos are content-addressed by SHA256 hash. Workflow:

  1. `make index`   - scans ~/Pictures for images and videos, builds
                      ~/.cache/picture-index (hash → filepath mapping)
  2. Drag media in edit mode - computes hash, inserts reference
  3. `make gallery` - finds image hashes in HTML, generates sizes from index
  4. `make videos`  - finds video hashes in HTML, transcodes from index

`make` or `make all` runs: sitemap, index, gallery, videos

Cleanup targets:
  `make unused`        - delete files with unreferenced hashes and obsolete
                         size variants (e.g., old 480p/720p after changing sizes)
  `make clean-symlinks` - delete symlinks so they can be recreated with
                         current default sizes (run gallery/videos after)

Image formats indexed: jpg, jpeg, png, gif, webp, heic, heif
Video formats indexed: mp4, mov, mkv, webm, avi

Image output (requires ImageMagick):
  - Sizes: 400, 800, 1600, 2400 pixels (longest edge)
  - HASH.jpg symlinks to HASH-800.jpg as default
  - Auto-orient, sharpen, strip metadata, progressive JPEG at quality 75

Video output (requires ffmpeg):
  - Resolutions: 360p, 540p (height-based scaling, width auto)
  - Codec: H.264 (main profile, level 4.0), AAC audio at 96kbps
  - Quality: CRF 26 (good balance of size/quality for web)
  - Uses -movflags +faststart for Safari streaming (moov atom at start)
  - HASH.mp4 symlinks to HASH-540p.mp4 as default
  - HASH-poster.jpg extracted from first frame

view.js handles responsive sizing differently for images and videos:

  Images: Uses srcset and sizes attributes. The browser chooses the best size
  based on display width and device pixel ratio. srcset lists all available
  widths (400w, 800w, 1600w, 2400w), sizes is set to container width / items
  per row. Fallback src is the 800px version.

  Videos: JavaScript selection at page load. No srcset equivalent exists for
  video, so src is rewritten directly. Selection logic:
    - Gallery videos: 540p if display width > 400px, else 360p
      (display width = min(1000, viewport) / items per row)
    - Standalone videos: 540p if viewport > 500px, else 360p

Videos not in gallery tables (e.g., inline in paragraphs) are constrained
to max-width: 100% via CSS and still get resolution selection applied.

/* NO-JS FALLBACK */

Each page includes a <noscript> link to sitemap.html. Browsers without
JavaScript (lynx, w3m, links, elinks) can navigate via the sitemap.
